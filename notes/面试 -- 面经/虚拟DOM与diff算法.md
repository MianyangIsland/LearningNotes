## 虚拟DOM

### 1.对虚拟DOM的理解?

从本质上来说,虚拟DOM是一个JavaScript对象,通过对象的方式来标识DOM结构.将页面的状态抽象为JS对象的形式,配合不同的渲染工具,使跨平台渲染成为可能.通过时间处理机制,将措辞DOM修改的结果一次性的更新到页面上,从而有效的减少页面渲染的次数,减少修改DOM的重绘重排次数,提高渲染性能.

### 2.虚拟DOM主要做了什么?

虚拟DOM是对DOM的抽象,这个对象是更加轻量级的对DOM的描述.他设计的最初目的,就是更好的跨平台.在代码渲染到页面之前,vue或react会把代码转换成一个对象(虚拟DOM).以对象的形式来描述真实dom结构,最终渲染到页面.在每次数据发生变化之前,虚拟dom都会缓存一份,变化之时,现在的虚拟dom会与虚拟dom进行比较.在vue或者react内部封装了diff算法,通过这个算法来进行比较,渲染时修改改变的变化,原先没有发生改变的通过原先的数据进行渲染.

为什么要用虚拟dom?

保证性能的下限,在不进行手动优化的情况下,提供过得去得性能.

方便跨平台操作.

## React diff算法的原理是什么?

实际上,diff算法探讨的就是虚拟dom树发生变化后,生成DOM树更新补丁的方式.它通过对比新旧两株DOM树的变更差异,将更新补丁作用于真实DOM,以最小成本完成视图更新.

![CgqCHl_qyouAAkb9AAB_cmWuZhc920_mh1609406106571.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e44d4ebb48a74ffda63754428c9d5273~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) 

具体的流程如下:

 真实的DOM首先会映射为虚拟DOM;

 当虚拟DOM发生变化后,就会根据差距计算生成patch,这个patch是一个结构化的数据,内容包含了增加,更新,移除等;

  根据patch去更新真实的DOM,反馈到用户的界面上.

![CgqCHl_qypGAZPuGAADYrK9nkJY878_mh1609406162857.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/246e03a02e3e48ff941f921843bd8676~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) 

diff算法可以总结为三个策略,分别从树,组件以及元素三个层面进行复杂度的优化:

策略一: 忽略节点跨层级操作场景,提升比对效率.(基于树进行对比).

这一策略需要进行树对比,即对树进行分层比较.树对比的处理收发是非常"暴力"的,即两棵树只对同一层次的节点进行比较,如果发现节点已经不存在了,则该节点及其子节点会被完全删除掉,不会用于进一步比较,这就提升了对比效率.

策略二:如果组件的class一致,则默认为相似的树结构,否则默认为不同的树结构.(基于组件进行对比).

在组件对比过程中:

 如果组件是同一类型则进行树对比;

 如果不是则直接放入补丁中.

只要父组件类型不同,就会被重新渲染.这也就是为什么shouldComponentUpdate,PureComponent及React.memo可以提升性能的原因.

策略三: 同一层的子节点,可以通过标记key的方式进行列表对比.(基于节点进行对比)

元素对比主要发生在同层级中国,通过标记节点操作生成补丁.节点操作包含了插入,移动,删除等.其中节点重新排序设计插入,移动,删除三个操作,所以效率消耗最大,此时策略三起到了至关重要的作用.通过标记key的方式,React可以直接移动DOM节点,降低内耗.

### React key是干嘛用的 为什么要加? key主要是解决哪一类问题的

Key是React用于追踪那些列表中元素被修改,被添加或者被移除的辅助标识.在开发过程中,我们需要保证某个元素的key在其同级元素中具有唯一性.

在React Diff 算法中React会借助元素的key值来判断该元素是新近创建的还是被移动而来的元素,从而减少不必要的元素重新渲染,此外,React还需要借助key值来判断元素与本地状态的关联关系.

注意事项:

 key值一定要和具体的元素一一对应;

尽量不要用数组的index去作为key;

  不要在render的时候用随机树或者其他操作给元素加上不稳定的key,这样造成的性能开销比不加key的情况下更糟.

### 虚拟DOM的引入与直接操作原生DOM相比,哪一个效率更高,为什么?

虚拟DOM相对原生的DOM不一定是效率更高的,如果只修改一个按钮的文案,那么虚拟DOM的操作无论如何都不可能比真实的DOM操作更快.在首次渲染大量DOM时,由于多了一层虚拟DOM的计算,虚拟FOM也会比innerHTML插入慢.它能保证性能下限,在真实DOM操作的时候进行针对性的优化时,还是更快的.所以要根据具体场景进行探讨.

虚拟 DOM 不是别的，正是前端开发们为了追求更好的研发体验和研发效率而创造出来的高阶产物。虚拟 DOM 并不一定会带来更好的性能，React 官方也从来没有把虚拟 DOM 作为性能层面的卖点对外输出过。**虚拟 DOM 的优越之处在于，它能够在提供更爽、更高效的研发模式（也就是函数式的 UI 编程方式）的同时，仍然保持一个还不错的性能。**

 