## 4.1 网络层概述

网络层的主要任务是实现网络层互联,进而实现数据包在各网络层之间的传输.

要实现网络层任务,需要解决以下主要问题:

   网络层向运输层提供怎样的服务("可靠传输"还是"不可靠传输").

   网络层寻址问题

   路由选择问题

因特网是目前全世界用户数量最多的互联网,它使用TCP/IP协议栈.

由于TCP/IP协议栈的网络层使用网际协议IP,它是整个协议栈的核心协议. 因此在TCP/IP协议栈中网络层常称为网际层.

## 4.2 网络层提供的两种服务:

 ![1661688472517](C:\Users\22719\AppData\Local\Temp\1661688472517.png)



### 4.3.1 Ipv4地址概述:

在TCP/IP体系中,IP地址是一个最基本的概念,我们必须把它弄清楚.

IPv4地址就是给因特网上的每一台主机(或路由器)的每一个接口分配一个在全世界范围内是唯一的32比特的标识符.

IP地址由因特网名字和数字分配机构ICANN进行分配.

我国用户可向亚太网络信息中心APNIC申请IP地址,需要缴费.

2011年2月3日,互联网号码分配管理局IANA宣布,IPv4地址已近分配完毕.

我国在2014至2015年也逐步停止向新用户和应用分配IPv4地址.同时全面开展商用部署Ipv6.

![1661690022730](C:\Users\22719\AppData\Local\Temp\1661690022730.png)

### 4.3.2 分类编制的IPv4地址

A类地址:

![1661694024935](C:\Users\22719\AppData\Local\Temp\1661694024935.png)

B类地址:

![1661694083140](C:\Users\22719\AppData\Local\Temp\1661694083140.png)

C类地址:

![1661694142144](C:\Users\22719\AppData\Local\Temp\1661694142144.png)

总结:

1.根据地址坐起第一个十进制数的值,可以判断出网络类别(小于127的为A类,128~191的为B类,192~223的为C类);

2.根据网络类别,就可以找出地址中的网络号部分和主机号部分(A类地址网络号为坐骑第一个字节,B类地址网络号为坐起前两个字节,C类地址网络号为做排期前三个字节);

3.以下三种情况的地址不能指派给主机或路由器接口:

(1)A类网络号为0和127 (2)主机号为"全0",,这是网络地址. (3)主机号为"全1",这是广播地址.

![1661694409212](C:\Users\22719\AppData\Local\Temp\1661694409212.png)

### 4.4.3 划分子网的IPv4地址:

为新增网络申请新的网络号会带来以下弊端:

  需要等待时间和花费更多的费用,会增加其他路由器中路由表记录的数量,浪费原有网络号中剩余的大量IP地址.

可以从主机号部分借用一部分比特作为子网号

32比特的子网掩码可以表面分类IP地址的主机号部分被借用了几个比特作为子网号

   子网掩码使用连续的比特1来对应网络号和子网号

   子网掩码使用连续的比特0来对应主机号

​    将划分子网的IPv4地址与其相应的子网掩码进行逻辑与运算就可以得到IPv4地址所在子网的网络地址

给定一个分类的Ip地址和相应的子网掩码,就可知道子网划分的细节:

  划分出的子网数量    每个子网可分配的IP地址数量    每个子网的网络地址和广播地址    每个子网可分配的最小和最大地址.

默认的子网掩码是指在未划分子网的情况下使用的子掩码.

 A类 : 255.0.0.0     B类: 255.255.0.0   C类: 255.255.255.0

### 4.3.4 无分类编址的IPv4地址:



![1661699960192](C:\Users\22719\AppData\Local\Temp\1661699960192.png)

### 4.3.5 IPv4地址的应用规划:

定长的子码掩码FLSM:

使用同一个子网掩码来划分子网,子网划分方式不灵活:只能划分出2^n个子网(n是从主机号部分借用的用来作为子网号的比特数量),每个子网所分配的IP地址数量相同,容易造成Ip地址浪费.

变长的子网掩码VLSM:

使用不同的子网掩码来划分子网,子网划分方式灵活:可以按需分配 ,每个子网所分配的IP地址数量可以不同,尽可能减少对IP地址的浪费.

![1661701267253](C:\Users\22719\AppData\Local\Temp\1661701267253.png)

![1661701288459](C:\Users\22719\AppData\Local\Temp\1661701288459.png)

### 4.4 IP数据报的发送和转发过程

IP数据报的发送和转发过程包含以下两部分:

 主机发送IP数据报     路由器转发IP数据报

![1661742430069](C:\Users\22719\AppData\Local\Temp\1661742430069.png)

主机C如何知道路由器R的存在?

用户为了让本网络的主机能和其他网络中的主机进行通信,就必须给其指定本网络中的一个路由器,由该路由器帮忙进行转发.所指定的路由器也被指定为默认网关.

路由器接收到IP数据报后如何转发?

 1.检查IP数据报首部是否出错:若出错,则直接丢弃该IP数据报并通告源主机,若没有出错,则直接进行转发.

 2.根据IP数据报的目的地址在路由表中查找匹配的条目:若找到匹配的条目,则转发给条目中指示的下一跳,若找不到,则丢弃该IP数据报并通告源主机.

### 4.5 静态路由配置及其可能产生的路由环路问题

静态路由配置是指用户或网络管理员使用路由器的相关命令给路由器人工配置路由表.

  这种人工配置方式简单,开销小.但不能及时适应网络状态(流量,拓扑等)的变化.

  一般只在小规模网络中采用.

适应静态路由配置可能出现以下导致产生路由环路的错误:  配置错误   聚合了不存在的网络   网络故障

路由条目的类型:  直连网络   静态路由(人工配置)    动态路由(路由选择协议)

特殊的静态路由条目:  默认路由(目的网络为0.0.0.0  ,  地址掩码为0.0.0.0);

特定主机路由(目的网络为特定主机的IP地址,地址掩码为255.255.255.255);

黑洞路由(下一跳为null0);

### 4.6.1路由选择协议概述

![1661764532160](C:\Users\22719\AppData\Local\Temp\1661764532160.png)

### 4.6.2  路由信息协议RIP的基本工作原理

  路由信息协议RIP是内部网关协议IGP中最先得到广泛使用的协议之一,其相关标准文档为RFC1058.

RIP要求自治系统AS内的每一个路由器都要维护从它自己到AS内其他每一个网络的距离记录.这是一组距离,称为"距离向量D-V".

RIP使用跳数作为度量来衡量到达目的网络的距离.

  路由器到直连网络的距离定义为1.

  路由器到非直连网络的距离定义为所经过的路由器数加1.

  允许一条路径最多只能包含15个路由器."距离"等于16时相当于不可达,因此RIP只适用小型互联网.

RIP认为好的路由就是"距离短"的路由,也就是所通过路由器数量最少的路由.

当到达同一目的网络有多条"距离相等"的路由时,可以进行等价负载均衡.

RIP包含以下三个要点:

 和谁交换信息:         仅和相邻路由器交换信息.

 交换什么信息          自己的路由表

 何时交换信息           周期性交换(例如30秒)

RIP的基本工作过程:

​    路由器开始工作时,只知道自己到直连网络的距离为1. 每个路由器仅和相邻路由器周期性地交换并更新路由信息.  若干次交换和更新后,每个路由器都知道到达本AS内各网络地最短距离和下一跳地址,称为收敛.

RIP地路由条目的更新规则:

  发现了新的网络,添加, 到达目的网络,不同下一跳,新路由优势,更新.   到达目的网络,不同下一跳,等价负载均衡.   到达目的网络,相同下一跳,最新消息,更新.           到达目的网络,不同下一跳,新路由劣势,不更新.

RIP存在"坏消息传播得慢"的问题

"坏消息传播得慢"又称为路由环路或距离无穷技术问题,这是距离向量算法的一个固有问题.可以采取多种措施减少出现在该问题的概率或减小该问题带来的危害. 

  限制最大路劲距离为15(16表示不可达).

   当路由表发生变化时就立即发送更新报文(即"触发更新"),而不仅是周期性发送.

   让路由器记录收到某特定路由信息的接口,而不让同一路由信息通过此接口反方向传送(即"水平分割").

### 4,6.3  开放最短路径优先OSPF的基本工作原理

 开放最短路径优先OSPF,是为克服RIP的缺点在1989年开发出来的.

​    "开放"表面OSPF协议不是受某一家厂商控制,而是公开发表的.

​     "最短路径优先"是因为使用了迪杰斯特拉提出的最短路径算法SPF.

OSPF是基于链路状态的,而不像RIP那样是基于距离向量的.

OSPF采用SPF算法计算路由,从算法上保证了不会产生路由环路.

OSPF不限制网络规模,更新效率高,收敛速度快.

链路状态是指本路由器都和那些路由器相邻,以及相应链路的"代价".

   代价用来表示费用,距离,时延,带宽,等等.这些都由网络管理人员来决定.

使用OSPF的每个路由器都已产生链路状态通告LSA.LSA中包括以下内容:直连网络的链路状态信息 ,  邻居路由器的链路状态信息.

LSA被封装在链路状态更新分组LSU中,采用洪范法发送.  使用OSPF的每个路由器都有一个链路状态数据库LSDB,用于存储LSA.

通过各路由器洪范发送基于LSDB进行最短路径优先SPF计算,各路由器的LSDB最终将达到一至.

使用OSPF的各路由器基于LSDB进行最短路径优先SPF计算,构建出各自到达其他各路由器的最短路径,即构建各自的路由表.

OSPF有以下五种分组类型

问候分组  数据库描述分组   链路状态请求分组   链路状态更新分组   链路状态确认分组

OSPF在多点接入网络中路由器邻居关系的建立:

选举指定路由器DR和备用的指定路由器BDR.  所有非DR/BDR只与DR/BDR建立邻居关系, 非DR/BDR之间通过DR/BDR交换信息.

为了使OSPF能够用于规模很大的网络,OSPF把一个自治心态再划分为若干个更小的范围,叫做区域.

  划分区域的好处就是把利用洪范法交换链路状态体信息的范围局限于每一个区域而不是整个自治系统,这就减少了整个网络上的通信量.

### 4.6.4 边界网关协议BGP的基本工作原理

外部网关协议EFP(例如边界网关协议BGP):

​        在不同自治系统内,度量路由的"代价"*距离,宽带,费用可能不同. 因此对于自治系统之间的路由选择,使用"代价"作为度量来寻找最佳路由是不行的.

​        自治心痛之间的路由选择必须考虑相关策略(政治,经济,安全等)

​        BGP只能是力求寻找一条能够到达目的网络且比较好的路由(不能兜圈子),而并非要寻找一条最佳路径.

在配置BGP时,每个自治系统的管理员要选择至少一个路由器作为该自治系统的"BGP发言人".

不同自治系统的BGP发言人要交换路由信息,首先必须建立TCP连接,端口号为179:

​                在此TCP连接上交换BGP报文以建立BGP绘话. 利用BGP会话交换路由信息(例如,增加新的路由,或撤销过时的路由,以及报告出错的情况等). 使用TCP连接交换路由信息的两个BGP发言人,彼此称为对方的邻站或对等站.

BGP发言人除了运行BGP外,还必须运行自己所在自治系统所使用的内部王关协议IGP,例如OSPF或RIP.

BGP发言人交换网络可达性的信息(要到达某个网络所要经过的一系列自治系统).

当BGP发言人互相交换了网络可达性的信息后,各BGP发言人就更具所采用的策略从受到的路由信息中找出到达各自治系统较好的路由.也就是构造出树形结构,不存在回路的自治系统连通图.

BGP适用于多级结构的因特网

BGP-4有以下四种报文:

   OPEN(打开)报文:用来与相邻的另一个BGP发言人建立关系,使通信初始化.

   UPDATE(更新)报文;用来通告某一路由的信息,以及列出要撤销的多条路由.

   KEEPALIVE(保活)报文:用来周期性地证实邻站地连通性.

   NOTIFICATION(通知)报文;用来发送检测到地差错.

补充: 自治系统之间需要使用外部网关协议EGP这一类协议,具体为边界网关协议BGP,目前使用最多地版本时BGP-4; BGP-4报文被封装在TCP报文段中进行传输.

![1661771639375](C:\Users\22719\AppData\Local\Temp\1661771639375.png)

### 4.7 Ipv4数据报地首部格式:

![1661783095267](C:\Users\22719\AppData\Local\Temp\1661783095267.png)

版本: 占4比特,表示IP协议地版本. 通信双方使用地IP协议地版本必须一致.目前广泛使用地协议版本号为4(即IPv4).

首部长度:占4比特,表示IP数据报首部地长度.该字段地取值以4字节为单位.最小十进制取值为5,表示IP数据报首部只有20字节固定部分.最大十进制取值为15,表示IP数据报首部包含20字节固定部分和最大40字节可变部分.

可选字段:长度从1各字节到40个字节不等.用来支持排错,测量及安全等措施. 可选字段增加了IP数据报功能,但这同时也使得Ip数据报地首部长度成为可变的.着就增加了每一个路由器处理IP数据报地开销.实际上可选字段很少被使用.

填充字段:确保首部长度为4字节地整数倍.使用全0进行填充.

总长度:占16比特,表示IP数据报地总长度(首部+数据载荷),最大取值为十进制地65535,以字节为单位.

数据载荷长度= 总长度 - 首部长度.

![1661783767349](C:\Users\22719\AppData\Local\Temp\1661783767349.png)

标识:占16比特,属于同一个数据报地各分片数据报应该具有相同地标识,IP软件维持一个计数器,每产生一个数据报,计数器值加1,并将此值赋值给标识字段.

标志:占3比特,各比特含义如下: DF位:1表示不允许分片; 0 表示允许分片.  MF位:1 表示"后面还有分片", 0表示"这是最后一个分片".

保留位:必须为0.

片偏移: 占13个比特,指出分片数据报地数据载荷部分偏移其在原数据报地位置有多少单位. 片偏移以8个字节为单位.(必须为整数).

生存时间TTL: 占8比特,最初以秒为单位,最大生存周期为255秒;路由器转发IP数据报时,将IP数据报首部中地该字段的值减去IP数据报在本路由器上所耗费的时间,若不为0就转发,否则就丢弃.现在以"跳数"为单位,路由器转发IP数据报时,将Ip数据报首部中的该字段的值减1,若不为0就转发,否则就丢弃.

![1661784777573](C:\Users\22719\AppData\Local\Temp\1661784777573.png)

协议:占8比特,指明IPv4数据报部分是何种协议数据单元.常用的一些协议和相应的协议字段值如下.

![1661784873875](C:\Users\22719\AppData\Local\Temp\1661784873875.png)

首部检验和字段: 占16比特,用来检测首部在传输过程中是否出现差错.比CRC检验码简单,称为因特网检验和. IP数据报每经过一个路由器,路由器都要重新计算首部检验和,因为某些字段(生存时间,标志,片偏移等)的取值可能发生变化. 由于IP层本身不提供可靠传输的服务,并且计算首部校验和是一项耗时的操作,因此在IPv6中,路由器不再计算首部校验和,从而更快转发Ip数据报.

源IP地址和目的Ip地址: 各占32比特,用来填写发送该Ip数据报的源主机的IP地址和接收该IP数据报的目的主机的Ip地址.

